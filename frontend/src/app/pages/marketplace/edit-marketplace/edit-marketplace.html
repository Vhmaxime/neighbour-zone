<div class="max-w-2xl mx-auto py-8 px-4">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Edit Marketplace Item</h1>
    <p class="text-gray-500">Update the details of your listing.</p>
  </div>

  @if (isLoading()) {
    <app-loading-component />
  } @else if (item(); as data) {
    <form
      (ngSubmit)="onSubmit()"
      [formGroup]="editForm"
      class="bg-white p-6 rounded-xl border shadow-sm space-y-6"
    >
      @if (error()) {
        <div class="bg-red-50 text-red-600 p-3 rounded-lg border border-red-200">
          {{ error() }}
        </div>
      }

      <div class="w-full">
        <label
          class="block text-sm font-medium text-gray-700 mb-1 [.invalid]:text-red-500!"
          [class.invalid]="editForm.get('title')?.invalid && editForm.get('title')?.touched"
          for="title"
          >Title</label
        >
        <input
          id="title"
          type="text"
          formControlName="title"
          [class.invalid]="editForm.get('title')?.invalid && editForm.get('title')?.touched"
          class="block w-full border [.invalid]:border-red-500! [.invalid]:ring-red-500! [.invalid]:text-red-500! border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="e.g. Vintage Bicycle"
        />
        @if (editForm.get('title')?.invalid && editForm.get('title')?.touched) {
          @if (editForm.get('title')?.errors?.['required']) {
            <span class="text-red-500 text-sm">required</span>
          } @else if (editForm.get('title')?.errors?.['minlength']) {
            <span class="text-red-500 text-sm">minimal 3 characters</span>
          } @else if (editForm.get('title')?.errors?.['maxlength']) {
            <span class="text-red-500 text-sm">maximal 50 characters</span>
          }
        }
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
          <select
            formControlName="category"
            class="block w-full border [.invalid]:border-red-500! [.invalid]:ring-red-500! [.invalid]:text-red-500! border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="offered">Offered (Selling/Giving)</option>
            <option value="wanted">Wanted (Looking for)</option>
          </select>
        </div>

        <div>
          <label
            class="block text-sm font-medium text-gray-700 mb-1 [.invalid]:text-red-500!"
            [class.invalid]="editForm.get('price')?.invalid && editForm.get('price')?.touched"
            for="price"
            >Price (â‚¬)</label
          >
          <input
            id="price"
            type="text"
            formControlName="price"
            [class.invalid]="editForm.get('price')?.invalid && editForm.get('price')?.touched"
            class="block w-full border [.invalid]:border-red-500! [.invalid]:ring-red-500! [.invalid]:text-red-500! border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Start typing to search..."
          />
        </div>
      </div>

      <div class="w-full relative">
        <label
          class="block text-sm font-medium text-gray-700 mb-1 [.invalid]:text-red-500!"
          [class.invalid]="
            editForm.get('placeDisplayName')?.invalid && editForm.get('placeDisplayName')?.touched
          "
          for="placeDisplayName"
          >Location</label
        >
        <input
          id="placeDisplayName"
          type="text"
          formControlName="placeDisplayName"
          [class.invalid]="
            editForm.get('placeDisplayName')?.invalid && editForm.get('placeDisplayName')?.touched
          "
          class="block w-full border [.invalid]:border-red-500! [.invalid]:ring-red-500! [.invalid]:text-red-500! border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Start typing to search..."
        />
        @if (
          editForm.get('placeDisplayName')?.invalid && editForm.get('placeDisplayName')?.touched
        ) {
          @if (editForm.get('placeDisplayName')?.errors?.['required']) {
            <span class="text-red-500 text-sm">required</span>
          }
        }
        @if (searchResults().length > 0) {
          <div class="absolute z-10 w-full mt-1">
            <app-location-search-results
              [locations]="searchResults()"
              (locationSelected)="onLocationSelected($event)"
            ></app-location-search-results>
          </div>
        }
      </div>

      <div class="flex flex-col">
        <label
          class="text-sm font-medium text-gray-700 mb-1 [.invalid]:text-red-500!"
          [class.invalid]="
            editForm.get('description')?.invalid && editForm.get('description')?.touched
          "
          for="description"
          >Description</label
        >
        <textarea
          id="description"
          type="text"
          formControlName="description"
          [class.invalid]="
            editForm.get('description')?.invalid && editForm.get('description')?.touched
          "
          class="border [.invalid]:border-red-500! [.invalid]:ring-red-500! [.invalid]:text-red-500! border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Describe the condition, size, etc..."
        ></textarea>
        @if (editForm.get('description')?.invalid && editForm.get('description')?.touched) {
          @if (editForm.get('description')?.errors?.['maxlength']) {
            <span class="text-red-500 text-sm">maximal 150 characters</span>
          }
        }
      </div>

      <div class="flex items-center justify-between pt-4 border-t border-gray-50">
        <app-action-button
          [itemId]="data.id"
          [authorId]="data.provider.id || data.provider_id || ''"
          [itemType]="'marketplace'"
          [itemTitle]="editForm.get('title')?.value ?? ''"
          mode="delete"
          (deleted)="onItemDeleted()"
        />

        <div class="flex items-center gap-4">
          <a
            routerLink="/marketplace"
            class="text-sm font-semibold text-gray-500 hover:text-gray-800 transition-colors"
          >
            Cancel
          </a>
          <button
            type="submit"
            [disabled]="!editForm.valid || isSubmitting()"
            class="px-8 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 disabled:opacity-50 transition-all shadow-lg shadow-blue-100"
          >
            @if (isSubmitting()) {
              Saving changes...
            } @else {
              Save changes
            }
          </button>
        </div>
      </div>
    </form>
  } @else {
    <div class="text-center py-10">
      <p class="text-red-500 font-bold">Error: Item not found or could not be loaded.</p>
      <a routerLink="/marketplace" class="text-blue-600 underline mt-2 block"
        >Go back to marketplace</a
      >
    </div>
  }
</div>
