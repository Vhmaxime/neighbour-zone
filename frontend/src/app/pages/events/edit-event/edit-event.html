@if (isLoading()) {
  <app-loading-component />
}

@if (event(); as event) {
  <div class="max-w-2xl mx-auto py-8 px-4">
    <div class="mb-8">
      <app-back-button />
      <h1 class="text-3xl font-bold text-gray-900">Organize an Event</h1>
    </div>

    <form
      (ngSubmit)="onSubmit()"
      [formGroup]="eventForm"
      class="bg-white p-6 rounded-xl border shadow-sm space-y-6"
    >
      @if (error()) {
        <div class="bg-red-50 text-red-600 p-3 rounded-lg border border-red-200">
          {{ error() }}
        </div>
      }

      <div class="w-full">
        <label
          class="block text-sm font-medium text-gray-700 mb-1 [.invalid]:text-red-500!"
          [class.invalid]="eventForm.get('title')?.invalid && eventForm.get('title')?.touched"
          for="title"
          >Event Title</label
        >
        <input
          id="title"
          type="text"
          formControlName="title"
          [class.invalid]="eventForm.get('title')?.invalid && eventForm.get('title')?.touched"
          class="block w-full border [.invalid]:border-red-500! [.invalid]:ring-red-500! [.invalid]:text-red-500! border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        />

        @if (eventForm.get('title')?.invalid && eventForm.get('title')?.touched) {
          @if (eventForm.get('title')?.errors?.['required']) {
            <span class="text-red-500 text-sm">required</span>
          } @else if (eventForm.get('title')?.errors?.['minlength']) {
            <span class="text-red-500 text-sm">minimal 1 characters</span>
          } @else if (eventForm.get('title')?.errors?.['maxlength']) {
            <span class="text-red-500 text-sm">maximal 100 characters</span>
          }
        }
      </div>

      <div class="w-full relative">
        <label
          class="block text-sm font-medium text-gray-700 mb-1 [.invalid]:text-red-500!"
          [class.invalid]="
            eventForm.get('placeDisplayName')?.invalid && eventForm.get('placeDisplayName')?.touched
          "
          for="placeDisplayName"
          >Location</label
        >

        <input
          id="placeDisplayName"
          type="text"
          formControlName="placeDisplayName"
          [class.invalid]="
            eventForm.get('placeDisplayName')?.invalid && eventForm.get('placeDisplayName')?.touched
          "
          class="block w-full border [.invalid]:border-red-500! [.invalid]:ring-red-500! [.invalid]:text-red-500! border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Start typing to search..."
        />

        @if (
          eventForm.get('placeDisplayName')?.invalid && eventForm.get('placeDisplayName')?.touched
        ) {
          @if (eventForm.get('placeDisplayName')?.errors?.['required']) {
            <span class="text-red-500 text-sm">required</span>
          }
        }

        @if (searchResults().length > 0) {
          <div class="absolute z-10 w-full mt-1">
            <app-location-search-results
              [locations]="searchResults()"
              (locationSelected)="onLocationSelected($event)"
            ></app-location-search-results>
          </div>
        }
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="w-full">
          <label
            class="block text-sm font-medium text-gray-700 mb-1 [.invalid]:text-red-500!"
            [class.invalid]="
              eventForm.get('dateTime')?.invalid && eventForm.get('dateTime')?.touched
            "
            for="dateTime"
            >Event date and time</label
          >
          <input
            id="dateTime"
            type="datetime-local"
            formControlName="dateTime"
            [class.invalid]="
              eventForm.get('dateTime')?.invalid && eventForm.get('dateTime')?.touched
            "
            class="block w-full border [.invalid]:border-red-500! [.invalid]:ring-red-500! [.invalid]:text-red-500! border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          @if (eventForm.get('dateTime')?.invalid && eventForm.get('dateTime')?.touched) {
            @if (eventForm.get('dateTime')?.errors?.['required']) {
              <span class="text-red-500 text-sm">required</span>
            }
          }
        </div>
        <div class="w-full">
          <label
            class="block text-sm font-medium text-gray-700 mb-1 [.invalid]:text-red-500!"
            [class.invalid]="eventForm.get('endAt')?.invalid && eventForm.get('endAt')?.touched"
            for="endAt"
            >Event end date and time (optional)</label
          >
          <input
            id="endAt"
            type="datetime-local"
            formControlName="endAt"
            [class.invalid]="eventForm.get('endAt')?.invalid && eventForm.get('endAt')?.touched"
            class="block w-full border [.invalid]:border-red-500! [.invalid]:ring-red-500! [.invalid]:text-red-500! border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
      </div>

      <div class="flex flex-col">
        <label
          class="text-sm font-medium text-gray-700 mb-1 [.invalid]:text-red-500!"
          [class.invalid]="
            eventForm.get('description')?.invalid && eventForm.get('description')?.touched
          "
          for="description"
          >Description</label
        >
        <textarea
          id="description"
          type="text"
          formControlName="description"
          [class.invalid]="
            eventForm.get('description')?.invalid && eventForm.get('description')?.touched
          "
          class="border [.invalid]:border-red-500! [.invalid]:ring-red-500! [.invalid]:text-red-500! border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        ></textarea>
        @if (eventForm.get('description')?.invalid && eventForm.get('description')?.touched) {
          @if (eventForm.get('description')?.errors?.['required']) {
            <span class="text-red-500 text-sm">required</span>
          } @else if (eventForm.get('description')?.errors?.['minlength']) {
            <span class="text-red-500 text-sm">minimal 1 characters</span>
          } @else if (eventForm.get('description')?.errors?.['maxlength']) {
            <span class="text-red-500 text-sm">maximal 300 characters</span>
          }
        }
      </div>

      <div class="flex items-center gap-4">
        <button
          type="submit"
          [disabled]="!eventForm.valid || isSubmitting()"
          class="border-(--accent)! m-0! w-full enabled:hover:text-(--accent)! border-2! enabled:hover:bg-transparent! rounded-lg! px-4! py-2! disabled:opacity-50! disabled:cursor-not-allowed! transition-all! bg-accent! text-white! font-medium!"
        >
          @if (isSubmitting()) {
            Saving...
          } @else {
            Sacve Changes
          }
        </button>
        <app-action-button
          [itemId]="event.id"
          [authorId]="event.organizer.id"
          [itemType]="'event'"
          [itemTitle]="event.title"
          mode="delete"
          (deleted)="onEventDeleted()"
        />

        <a [routerLink]="['/events', eventId]" class="btn-cancel">Cancel</a>
      </div>
    </form>
  </div>
}
